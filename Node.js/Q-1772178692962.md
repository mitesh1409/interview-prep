# Middleware in Express.js

References:  

* [Writing middleware for use in Express apps](https://expressjs.com/en/guide/writing-middleware.html)
* [Using middleware](https://expressjs.com/en/guide/using-middleware.html)

---

## Middleware Basics

Every middleware function in Express has this signature:

```javascript
function myMiddleware(req, res, next) {
    // do something
    next(); // pass control to the next middleware
}
```

`next()` — moves to the next middleware
`next(err)` — skips all normal middleware and jumps straight to the **error handler**

---

## The Express 4 Problem

In Express 4, if you had an `async` middleware and something threw an error, you had to **manually catch it and call `next(err)`** yourself. Express had no idea about Promise rejections.

```javascript
// Express 4 — you had to do this manually
async function validateCookies(req, res, next) {
    try {
        await cookieValidator(req.cookies); // what if this throws?
        next();
    } catch (err) {
        next(err); // had to manually forward the error
    }
}
```

If you forgot the `try/catch`, the error would become an **unhandled Promise rejection** and Express error handlers would never receive it.

---

## Express 5 — Automatic Error Forwarding

In Express 5, if a middleware returns a Promise (i.e. it's `async`), Express automatically watches that Promise. If it **rejects or throws**, Express automatically calls `next(rejectedValue)` for you.

```javascript
// Express 5 — no try/catch needed!
async function validateCookies(req, res, next) {
    await cookieValidator(req.cookies); // if this throws, Express calls next(err) automatically
    next(); // only reached if cookieValidator succeeded
}
```

Clean, no boilerplate. Express handles the rejection behind the scenes.

---

## Full Working Example — Express 5

```javascript
const express = require('express');
const app = express();

// Simulated async DB call that might fail
async function fetchUserFromDB(userId) {
    if (userId !== '42') {
        throw new Error(`User with id ${userId} not found`); // simulates DB error
    }
    return { id: '42', name: 'John Doe' };
}

// Async middleware — no try/catch needed in Express 5
async function loadUser(req, res, next) {
    const user = await fetchUserFromDB(req.params.id); // throws if user not found
    req.user = user; // attach user to request for next middleware to use
    next(); // move on if successful
}

// Route
app.get('/user/:id', loadUser, (req, res) => {
    res.json(req.user);
});

// Error handler — Express identifies this by the 4 arguments (err, req, res, next)
app.use((err, req, res, next) => {
    console.error('Error caught by error handler:', err.message);
    res.status(500).json({ error: err.message });
});

app.listen(3000, () => console.log('Server running on port 3000'));
```

**What happens:**

- `GET /user/42` → `fetchUserFromDB` resolves → `req.user` is set → `next()` called → route responds with user JSON
- `GET /user/99` → `fetchUserFromDB` throws → Express 5 catches the rejection → automatically calls `next(err)` → error handler responds with `{ error: "User with id 99 not found" }`

---

## How the Error Handler Works

The error handler is just a middleware with **4 parameters** instead of 3 — Express recognises it by the `err` as the first argument:

```javascript
// Normal middleware     — 3 params
app.use((req, res, next) => { });

// Error handler middleware — 4 params (err is first)
app.use((err, req, res, next) => { });
```

When `next(err)` is called (either manually in Express 4 or automatically in Express 5), Express **skips all normal middlewares** and jumps directly to this error handler.

---

## Express 4 vs Express 5 — Side by Side

```javascript
// ❌ Express 4 — boilerplate try/catch in every async middleware
async function loadUser(req, res, next) {
    try {
        const user = await fetchUserFromDB(req.params.id);
        req.user = user;
        next();
    } catch (err) {
        next(err); // had to do this manually
    }
}

// ✅ Express 5 — clean, no boilerplate
async function loadUser(req, res, next) {
    const user = await fetchUserFromDB(req.params.id); // error auto-forwarded
    req.user = user;
    next();
}
```

---

## Key Takeaways

- `next()` → proceed normally to next middleware
- `next(err)` → skip to error handler
- In **Express 4**, async errors in middleware had to be manually forwarded via `try/catch` + `next(err)`
- In **Express 5**, Express watches the returned Promise — if it rejects or throws, it calls `next(err)` automatically
- The error handler always has **4 parameters** `(err, req, res, next)` and must be registered **last** with `app.use()`
